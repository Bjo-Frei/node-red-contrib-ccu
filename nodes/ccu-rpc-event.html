<script type="text/javascript">
    RED.nodes.registerType('ccu-rpc-event', {

        category: 'ccu',
        defaults: {
            name: {value: ''},
            iface: {value: ''},
            ccuConfig: {value: 'localhost', type: 'ccu-connection', required: true},
            rooms: {value: ''},
            roomsRx: {value: 'str'},
            functions: {value: ''},
            functionsRx: {value: 'str'},
            device: {value: ''},
            deviceRx: {value: 'str'},
            deviceName: {value: ''},
            deviceNameRx: {value: 'str'},
            deviceType: {value: ''},
            deviceTypeRx: {value: 'str'},
            channel: {value: ''},
            channelRx: {value: 'str'},
            channelName: {value: ''},
            channelNameRx: {value: 'str'},
            channelType: {value: ''},
            channelTypeRx: {value: 'str'},
            datapoint: {value: ''},
            datapointRx: {value: 'str'},
            change: {value: false},
            working: {value: false},
            cache: {value: false},
            topic: {value: '${CCU}/${Interface}/${channelName}/${datapoint}'} // eslint-disable-line no-template-curly-in-string
        },
        inputs: 0,
        outputs: 1,
        icon: 'ccu.png',
        color: '#4691BA',
        paletteLabel: 'rpc event',
        label() {
            return this.name || ('rpc event');
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare() {
            const that = this;
            const $nodeInputIface = $('#node-input-iface');
            const $nodeInputCcuConfig = $('#node-input-ccuConfig');

            let data;

            let ifacesLoaded = false;
            let ifacesPending = false;

            $('.filter').each(function () {
                const id = $(this).prop('id');
                const $type = $('#' + id + 'Rx');
                const name = id.split('-').pop() + 'Rx';
                $type.val(that[name]);

                const $this = $(this);

                $this.typedInput({
                    typeField: $type,
                    types: ['str', 're']
                }).typedInput('width', '70%');

                const $input = $this.parent().find('.red-ui-typedInput-input input');

                $input.autocomplete({
                    source: [],
                    close: () => {
                        $input.trigger('change');
                    },
                    delay: 0,
                    minLength: 0
                });

                $this.on('change', (type, value) => {
                    if (value === 're') {
                        $input.autocomplete('disable');
                    } else {
                        $input.autocomplete('enable');
                    }
                });
            });

            function loadIfaces(iface, cb) {
                if (ifacesPending) {
                    return;
                }
                ifacesPending = true;
                console.log('loadIfaces()');
                $nodeInputIface.html('<option value="">*</option>');
                const nodeId = $nodeInputCcuConfig.val();
                if (nodeId === '_ADD_') {
                    if (typeof cb === 'function') {
                        cb();
                        ifacesPending = false;
                    }
                } else {
                    const url = 'ccu?config=' + nodeId + '&type=ifaces';
                    $.getJSON(url, d => {
                        Object.keys(d).forEach(i => {
                            $nodeInputIface.append('<option' + (d[i].enabled ? '' : ' disabled') + (i === iface ? ' selected' : '') + '>' + i + '</option>');
                        });
                        if (typeof cb === 'function') {
                            cb();
                            ifacesPending = false;
                        }
                    });
                }
            }

            $nodeInputCcuConfig.change(() => {
                loadIfaces(this.iface, () => {
                    ifacesLoaded = true;
                    $nodeInputIface.removeAttr('disabled');
                    loadConfig();
                });
            });

            function loadConfig() {
                if (ifacesLoaded) {
                    console.log('loadConfig');
                    const nodeId = $nodeInputCcuConfig.val();
                    const url = 'ccu?config=' + nodeId;
                    $.getJSON(url, d => {
                        data = d;
                        autocompleteRoomsFunctions();
                        autocompleteDevices();
                    });
                }
            }

            $('#node-input-iface').change(() => {
                autocompleteDevices();
            });

            function autocompleteRoomsFunctions() {
                if (!data) {
                    return;
                }
                $('#node-input-rooms').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', data.rooms);
                $('#node-input-functions').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', data.functions);
            }

            function paramsetName(iface, device, paramset) {
                let cType = '';
                let d;
                if (device) {
                    if (device.PARENT) {
                        // channel
                        cType = device.TYPE;
                        d = data.metadata.devices[iface][device.PARENT];
                    } else {
                        // device
                        d = device;
                    }
                    return [iface, d.TYPE, d.FIRMWARE, d.VERSION, cType, paramset].join('/');
                }
            }

            function autocompleteDevices() {
                if (!data) {
                    return;
                }
                const iface = $('#node-input-iface').val();
                const lists = {
                    device: [],
                    deviceName: [],
                    deviceType: [],
                    channel: [],
                    channelName: [],
                    channelType: [],
                    datapoint: []
                };
                console.log('autocompleteDevices', iface);

                function composeLists(iface) {
                    if (!data.metadata.devices[iface]) {
                        return;
                    }

                    Object.keys(data.metadata.devices[iface]).forEach(device => {
                        if (device.match(/:\d+$/)) {
                            lists.channel.push(device);
                            lists.channelName.push(data.channelNames[device]);
                            if (!lists.channelType.includes(data.metadata.devices[iface][device].TYPE)) {
                                lists.channelType.push(data.metadata.devices[iface][device].TYPE);
                            }

                            const psName = paramsetName(iface, data.metadata.devices[iface][device], 'VALUES');
                            if (data.paramsetDescriptions[psName]) {
                                Object.keys(data.paramsetDescriptions[psName]).forEach(datapoint => {
                                    if (!lists.datapoint.includes(datapoint)) {
                                        lists.datapoint.push(datapoint);
                                    }
                                });
                            }
                        } else {
                            lists.device.push(device);
                            lists.deviceName.push(data.channelNames[device]);
                            if (!lists.deviceType.includes(data.metadata.devices[iface][device].TYPE)) {
                                lists.deviceType.push(data.metadata.devices[iface][device].TYPE);
                            }
                        }
                    });

                    $('#node-input-device').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.device);
                    $('#node-input-deviceName').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.deviceName);
                    $('#node-input-deviceType').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.deviceType);
                    $('#node-input-channel').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.channel);
                    $('#node-input-channelName').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.channelName);
                    $('#node-input-channelType').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.channelType);
                    $('#node-input-datapoint').parent().find('.red-ui-typedInput-input input').autocomplete('option', 'source', lists.datapoint);
                }

                if (iface) {
                    composeLists(iface);
                } else {
                    Object.keys(data.metadata.devices).forEach(iface => {
                        composeLists(iface);
                    });
                }
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="ccu-rpc-event">
    <div class="form-row">
        <label for="node-input-ccuConfig"><i class="icon-globe"></i> CCU</label>
        <input type="text" id="node-input-ccuConfig">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="icon-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic">
    </div>
    <div class="form-row">
        <label for="node-input-iface"><i class="fa fa-empire"></i> Interface</label>
        <select id="node-input-iface">
            <option value="">*</option>
       </select>
    </div>
    <div class="form-row">
        <label for="node-input-rooms"><i class="icon-bookmark"></i> room</label>
        <input type="text" class="filter" id="node-input-rooms">
        <input type="hidden" id="node-input-roomsRx">
    </div>
    <div class="form-row">
        <label for="node-input-functions"><i class="icon-bookmark"></i> function</label>
        <input type="text" class="filter" id="node-input-functions">
        <input type="hidden" id="node-input-functionsRx">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="icon-bookmark"></i> device</label>
        <input type="text" class="filter" id="node-input-device">
        <input type="hidden" id="node-input-deviceRx">
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="icon-bookmark"></i> deviceName</label>
        <input type="text" class="filter" id="node-input-deviceName">
        <input type="hidden" id="node-input-deviceNameRx">
    </div>
    <div class="form-row">
        <label for="node-input-deviceType"><i class="icon-bookmark"></i> deviceType</label>
        <input type="text" class="filter" id="node-input-deviceType">
        <input type="hidden" id="node-input-deviceTypeRx">
    </div>
    <div class="form-row">
        <label for="node-input-channel"><i class="icon-bookmark"></i> channel</label>
        <input type="text" class="filter" id="node-input-channel">
        <input type="hidden" id="node-input-channelRx">
    </div>
    <div class="form-row">
        <label for="node-input-channelName"><i class="icon-bookmark"></i> channelName</label>
        <input type="text" class="filter" id="node-input-channelName">
        <input type="hidden" id="node-input-channelNameRx">
    </div>
    <div class="form-row">
        <label for="node-input-channelType"><i class="icon-bookmark"></i> channelType</label>
        <input type="text" class="filter" id="node-input-channelType">
        <input type="hidden" id="node-input-channelTypeRx">
    </div>
    <div class="form-row">
        <label for="node-input-datapoint"><i class="icon-tag"></i> datapoint</label>
        <input type="text" class="filter" id="node-input-datapoint">
        <input type="hidden" id="node-input-datapointRx">
    </div>
    <div class="form-row">
        <label for="node-input-change"><i class="icon-bookmark"></i> </label>
        <div style="width: 70%; display: inline-block; vertical-align: text-top;">
            <label class="ccu-checkbox" for="node-input-change">
                <input type="checkbox" id="node-input-change">
                <span data-i18n="ccu-rpc-event.change"></span>
            </label>

            <label class="ccu-checkbox">
                <input type="checkbox" id="node-input-working">
                <span data-i18n="ccu-rpc-event.working"></span>
            </label>

            <label class="ccu-checkbox">
                <input type="checkbox" id="node-input-cache">
                <span data-i18n="ccu-rpc-event.cache"></span>
            </label>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <style>
        .ccu-checkbox {
            width: auto !important;
            display: block !important;
        }
        .ccu-checkbox input {
            width: 24px;
            margin-top: -3px;
        }
    </style>
</script>

<script type="text/x-red" data-help-name="ccu-rpc-event" lang="de-DE">
    <p>Gibt RPC Events aus.</p>
</script>

<script type="text/x-red" data-help-name="ccu-rpc-event" lang="en-US">
    <p>Outputs RPC events.</p>
</script>