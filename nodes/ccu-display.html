<script type="text/javascript">

    RED.nodes.registerType('ccu-display', {

        category: 'ccu',
        defaults: {
            name: {value: ''},
            iface: {value: 'BidCos-RF', required: true},
            channel: {value: '', required: true},
            chime: {value: ''},
            length: {value: 10800},
            repeat: {value: 1},
            volume: {value: 100},
            line1: {value: ''},
            icon1: {value: ''},
            line2: {value: ''},
            icon2: {value: ''},
            line3: {value: ''},
            icon3: {value: ''},
            signal: {value: ''},
            channelType: {value: ''},
            led: {value: ''},
            ccuConfig: {value: '', type: 'ccu-connection', required: true}
        },
        inputs: 1,
        outputs: 0,
        icon: 'ccu.png',
        color: '#4691BA',
        paletteLabel: 'submit',
        align: 'right',
        label() {
            return this.name || 'submit';
        },
        oneditprepare() {
            const $nodeInputChannel = $('#node-input-channel');
            const $nodeInputChannelType = $('#node-input-channelType');
            const $nodeInputCcuConfig = $('#node-input-ccuConfig')

            let data;
            let iface = this.iface;

            function loadConfig() {
                const nodeId = $nodeInputCcuConfig.val();
                if (nodeId && nodeId !== '__ADD__') {
                    $.getJSON('ccu?type=display&config=' + nodeId + '&iface=' + iface, d => {
                        data = d;
                        autoCompleteChannel();
                    });
                }

            }

            $nodeInputCcuConfig.change(loadConfig);

            $nodeInputChannel.autocomplete({
                source: [],
                close: () => {
                    if (!$nodeInputName.val()) {
                        const n = $nodeInputChannel.val().split(' ');
                        const channel = n.shift();
                        $nodeInputName.val(n.join(' '));
                        $nodeInputChannelType.val(data[channel].type);
                    }
                    autocompleteDatapoint();
                },
                delay: 0,
                minLength: 0
            });

            function autoCompleteChannel() {
                if (!data) {
                    return;
                }
                const arr = [];
                Object.keys(data).forEach(addr => {
                    if (addr.match(/:\d+$/)) {
                        if (data[addr].name) {
                            addr += ' ' + data[addr].name;
                        }
                        arr.push(addr);
                    }
                });
                console.log('autocomplete', arr);
                $nodeInputChannel.autocomplete('option', 'source', arr);

                if (!data[$nodeInputChannel.val().split(' ')[0]]) {
                    $nodeInputChannel.val('');
                }
            }

            $nodeInputChannel.change(() => {
                const channel = $nodeInputChannel.val();
                if (data && data[channel]) {
                    $nodeInputChannelType.val(data[channel]);
                }
            });


            $('#node-input-chime-container').css('min-height', '300px').css('min-width', '450px').editableList({
                sortable: true,
                removable: true,
                addItem: (container, i, data) => {
                    if ($('#node-input-chime-container').editableList('length') > 10) {
                        container.remove();
                    } else {
                        $('<input type="number" class="number mp3" min="0" max="255" style="width: 80px;" value="' + data.cmd + '"/>').appendTo(container);
                    }
                }
            });

            $('#node-input-led-container').css('min-height', '300px').css('min-width', '450px').editableList({
                sortable: true,
                removable: true,
                addItem: (container, i, data) => {
                    if ($('#node-input-led-container').editableList('length') > 10) {
                        $('#node-input-led-container').editableList('removeItem', {data});
                        return false;
                    }

                    const select = $('<select class="number led" value="' + data.cmd + '"/>').appendTo(container);
                    Object.keys(ccuSignalColors).forEach(name => {
                        $('<option value="' + ccuSignalColors[name] + '"' + (ccuSignalColors[name] === parseInt(data.cmd, 10) ? ' selected' : '') +
                            '>' + name + '</option>').appendTo(select);
                    });
                }
            });

            $('#node-input-key-container').css('min-height', '300px').css('min-width', '450px').editableList({});

            if (this.channelType === 'SIGNAL_CHIME') {
                const [volume, repeat, length, ...commands] = this.chime.split(',');
                $('#node-input-volume').val(Math.round(volume * 100));
                $('#node-input-repeat').val(repeat);
                $('#node-input-length').val(length);

                commands.forEach(cmd => {
                    $('#node-input-chime-container').editableList('addItem', {cmd});
                });
                console.log(volume, repeat, length, commands);
            } else if (this.channelType === 'SIGNAL_LED') {
                const [, repeat, length, ...commands] = this.led.split(',');
                $('#node-input-repeat').val(repeat);
                $('#node-input-length').val(length);
                commands.forEach(cmd => {
                    $('#node-input-led-container').editableList('addItem', {cmd});
                });
            } else if (this.channelType === 'KEY') {
                // TODO ...
                console.error('channelType KEY not yet implemented');
            } else {
                console.error('unknown channelType', this.chanellType);
            }

            $('.SUBMIT').hide();
            $('.SUBMIT' + $nodeInputChannelType.val()).show();
            $nodeInputChannelType.change(() => {
                $('.SUBMIT').hide();
                $('.SUBMIT' + $nodeInputChannelType.val()).show();
            });
        },
        oneditsave() {
            const $nodeInputChannelType = $('#node-input-channelType');
            switch ($nodeInputChannelType.val()) {
                case 'SIGNAL_CHIME': {
                    const chime = [$('#node-input-volume').val() / 100, $('#node-input-repeat').val(), '10800'];
                    $('#node-input-chime-container').editableList('items').each(function () {
                        chime.push($(this).find('input.number.mp3').val());
                    });
                    this.chime = chime.join(',');
                    break;
                }
                case 'SIGNAL_LED': {
                    const led = ['1', $('#node-input-repeat').val(), '10800'];
                    $('#node-input-led-container').editableList('items').each(function () {
                        led.push($(this).find('select').val());
                    });
                    this.led = led.join(',');
                    break;
                }
                case 'KEY':
                    break;

                default:
            }

            this.icon1 = $('#node-input-icon1').val();
            this.icon2 = $('#node-input-icon2').val();
            this.icon3 = $('#node-input-icon3').val();
        }
    });
</script>

<script type="text/x-red" data-template-name="ccu-display">
    <div class="form-row">
        <label for="node-input-ccuConfig"><i class="icon-globe"></i> CCU</label>
        <input type="text" id="node-input-ccuConfig">
    </div>
     <div class="form-row">
        <label for="node-input-topic"><i class="icon-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic">
    </div>
    <div class="form-row">
        <label for="node-input-iface"><i class="fa fa-empire"></i> Interface</label>
        <select id="node-input-iface">
            <option selected>BidCos-RF</option>
            <!--<option>BidCos-Wired</option>-->
            <!--<option>HmIP-RF</option>-->
            <!--<option>VirtualDevices</option>-->
            <!--<option>CUxD</option>-->
       </select>
    </div>
    <div class="form-row">
        <label for="node-input-channel"><i class="icon-tags"></i> Kanal</label>
        <input type="text" id="node-input-channel">
    </div>
    <div class="form-row">
        <label for="node-input-channelType"><i class="icon-tags"></i> Typ</label>
        <select id="node-input-channelType">
            <option value=""></option>
            <option value="DIS">HM-Dis-WM55</option>
            <option value="DIS-EP">HM-Dis-EP-WM55</option>
        </select>
    </div>



    <div class="form-row SUBMIT DIS DIS-EP">
        <label for="node-input-line1"><i class="icon-envelope"></i> Zeile 1</label>
        <input type="text" id="node-input-line1">
    </div>
    <div class="form-row SUBMIT DIS DIS-EP">
        <label for="node-input-icon1"><i class="icon-envelope"></i> Icon 1</label>
        <select id="node-input-icon1">
            <option value=""></option>
            <option value="0x80">Aus</option>
            <option value="0x81">Ein</option>
            <option value="0x82">Offen</option>
            <option value="0x83">Geschlossen</option>
            <option value="0x84">Fehler</option>
            <option value="0x85">Ok</option>
            <option value="0x86">Information</option>
            <option value="0x87">Neue Nachricht</option>
            <option value="0x88">Servicemeldung</option>
        </select>
    </div>
    <div class="form-row SUBMIT DIS DIS-EP">
        <label for="node-input-line2"><i class="icon-envelope"></i> Zeile 2</label>
        <input type="text" id="node-input-line2">
    </div>
    <div class="form-row SUBMIT DIS DIS-EP">
        <label for="node-input-icon2"><i class="icon-envelope"></i> Icon 2</label>
        <select id="node-input-icon2">
            <option value=""></option>
            <option value="0x80">Aus</option>
            <option value="0x81">Ein</option>
            <option value="0x82">Offen</option>
            <option value="0x83">Geschlossen</option>
            <option value="0x84">Fehler</option>
            <option value="0x85">Ok</option>
            <option value="0x86">Information</option>
            <option value="0x87">Neue Nachricht</option>
            <option value="0x88">Servicemeldung</option>
        </select>
    </div>
    <div class="form-row SUBMIT DIS DIS-EP">
        <label for="node-input-line3"><i class="icon-envelope"></i> Zeile 3</label>
        <input type="text" id="node-input-line3">
    </div>
    <div class="form-row SUBMIT DIS DIS-EP">
        <label for="node-input-icon3"><i class="icon-envelope"></i> Icon 3</label>
        <select id="node-input-icon3">
            <option value=""></option>
            <option value="0x80">Aus</option>
            <option value="0x81">Ein</option>
            <option value="0x82">Offen</option>
            <option value="0x83">Geschlossen</option>
            <option value="0x84">Fehler</option>
            <option value="0x85">Ok</option>
            <option value="0x86">Information</option>
            <option value="0x87">Neue Nachricht</option>
            <option value="0x88">Servicemeldung</option>
        </select>
    </div>
    <div class="form-row SUBMIT DIS">
        <label for="node-input-line4"><i class="icon-envelope"></i> Zeile 4</label>
        <input type="text" id="node-input-line4">
    </div>
    <div class="form-row SUBMIT DIS">
        <label for="node-input-icon4"><i class="icon-envelope"></i> Icon 4</label>
        <select id="node-input-icon4">
            <option value=""></option>
            <option value="0x80">Aus</option>
            <option value="0x81">Ein</option>
            <option value="0x82">Offen</option>
            <option value="0x83">Geschlossen</option>
            <option value="0x84">Fehler</option>
            <option value="0x85">Ok</option>
            <option value="0x86">Information</option>
            <option value="0x87">Neue Nachricht</option>
            <option value="0x88">Servicemeldung</option>
        </select>
    </div>
    <div class="form-row SUBMIT DIS">
        <label for="node-input-line5"><i class="icon-envelope"></i> Zeile 5</label>
        <input type="text" id="node-input-line5">
    </div>
    <div class="form-row SUBMIT DIS">
        <label for="node-input-icon5"><i class="icon-envelope"></i> Icon 5</label>
        <select id="node-input-icon5">
            <option value=""></option>
            <option value="0x80">Aus</option>
            <option value="0x81">Ein</option>
            <option value="0x82">Offen</option>
            <option value="0x83">Geschlossen</option>
            <option value="0x84">Fehler</option>
            <option value="0x85">Ok</option>
            <option value="0x86">Information</option>
            <option value="0x87">Neue Nachricht</option>
            <option value="0x88">Servicemeldung</option>
        </select>
    </div>
    <div class="form-row SUBMIT DIS-EP">
        <label for="node-input-signal"><i class="icon-envelope"></i> LED</label>
        <select id="node-input-signal">
            <option value="0xF0">Aus</option>
            <option value="0xF1">Rot</option>
            <option value="0xF2">Grün</option>
            <option value="0xF3">Orange</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>


</script>

<script type="text/x-red" data-help-name="ccu-display" lang="de-DE">
    <p>Senden von LED- und Tonsignalen.</p>
</script>

<script type="text/x-red" data-help-name="ccu-display" lang="en-US">
    <p>Send LED- and sound-signals.</p>
</script>